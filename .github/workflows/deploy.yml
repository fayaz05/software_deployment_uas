name: deploy-ssh

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to download (use "latest" for the latest release)'
        required: false
        default: "latest"
  release:
    types: [published]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Download app.zip from latest release
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: "app.zip"

      - name: Check SSH credentials
        run: |
          if [ -z "${{ secrets.SSH_KEY }}" ] || [ -z "${{ secrets.SSH_HOST }}" ] || [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "ERROR: one or more required secrets (SSH_KEY, SSH_HOST, SSH_USER) are missing."
            echo "Set them in Settings → Secrets and variables → Actions."
            exit 1
          fi

      - name: Copy app.zip to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "app.zip"
          target: "/srv/fayaz/"

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail

            echo "=== Ensure releases dir ==="
            mkdir -p /srv/fayaz/releases
            cd /srv/fayaz

            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            DEST="releases/$TIMESTAMP"
            mkdir -p "$DEST"

            echo "=== Extracting app.zip to $DEST ==="
            unzip -o app.zip -d "$DEST"

            # If the zip had a top-level directory, move its contents into the release dir
            # This keeps consistent layout: /srv/fayaz/releases/<timestamp>/{app files}
            TOP_ENTRIES=$(ls -A "$DEST" | wc -l || true)
            if [ "$TOP_ENTRIES" -eq 1 ] && [ -d "$DEST/$(ls -A "$DEST")" ]; then
              mv "$DEST/"*/. "$DEST/" || true
            fi

            echo "Folder terbaru: $DEST"

            echo "=== Install Dependencies (if package.json exists) ==="
            if [ -f "$DEST/package.json" ]; then
              cd "$DEST"
              npm install --production
            else
              echo "No package.json found in $DEST; skipping npm install"
            fi

            echo "=== Update Symlink ==="
            ln -sfn "$DEST" /srv/fayaz/current

            echo "=== Restart Service ==="
            # Use sudo if necessary. Ensure SSH_USER can run these commands (passwordless sudo or root).
            sudo systemctl daemon-reload || true
            sudo systemctl restart fayaz

            echo "=== Wait 3s for service ==="
            sleep 3

            echo "=== Health Check ==="
            HEALTH=$(curl -fsS http://localhost:3000/api/health || true)

            if [[ "$HEALTH" == *"OK"* ]]; then
              echo "Health check OK: $HEALTH"
            else
              echo "Health check FAILED!"
              sudo systemctl status fayaz --no-pager || true
              exit 1
            fi