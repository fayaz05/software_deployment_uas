name: deploy-ssh

on:
  workflow_dispatch:
  release:
    types: [published]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Download file app.zip dari Release terbaru
      - name: Download app.zip from latest release
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          tag: latest                # FIX: pengganti latest: true
          file-name: "app.zip"       # FIX: parameter benar (bukan fileName)

      # 2. Add server SSH Host Key
      - name: Add server host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}

      # 3. Upload app.zip ke server
      - name: Copy app.zip to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "app.zip"
          target: "/srv/fayaz/"
          overwrite: true

      # 4. Deploy via SSH
      - name: Deploy via SSH (atomic + systemd)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            cd /srv/fayaz

            ts="$(date -u +%Y-%m-%dT%H-%M-%SZ)"
            mkdir -p "releases/$ts"

            unzip -o app.zip -d "releases/$ts"

            cd "releases/$ts"
            if [ -f "package-lock.json" ]; then
              npm ci --omit=dev
            else
              npm install --omit=dev
            fi

            ln -sfn "/srv/fayaz/releases/$ts" /srv/fayaz/current

            sudo systemctl restart fayaz

            sleep 5
            if ! curl -fsS http://localhost:3000/health; then
              sudo journalctl -u fayaz -n 50 --no-pager
              exit 1
            fi

            ls -1dt /srv/fayaz/releases/* | tail -n +6 | xargs -r rm -rf
