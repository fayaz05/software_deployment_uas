name: deploy-ssh

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to download (use "latest" for the latest release)'
        required: false
        default: "latest"
  release:
    types: [published]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Download artifact (zip) dari Release GitHub
      - name: Download app.zip from latest release
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: "app.zip"

      # 2. Copy file to server
      - name: Copy app.zip to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "app.zip"
          target: "/srv/fayaz/"

      # 3. Deploy via SSH
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e

            echo "=== Ekstrak Release ==="
            mkdir -p /srv/fayaz/releases
            cd /srv/fayaz
            unzip -o app.zip -d .

            # Ambil folder terbaru
            LATEST=$(ls -td releases/* | head -n 1)

            echo "Folder terbaru: $LATEST"

            echo "=== Install Dependencies ==="
            cd $LATEST
            npm install --production

            echo "=== Update Symlink ==="
            ln -sfn "$LATEST" /srv/fayaz/current

            echo "=== Restart Service ==="
            systemctl daemon-reload
            systemctl restart fayaz

            echo "=== Tunggu 3 detik agar server boot ==="
            sleep 3

            echo "=== Health Check ==="
            HEALTH=$(curl -fsS http://localhost:3000/api/health || true)

            if [[ "$HEALTH" == *"OK"* ]]; then
              echo "Health check OK: $HEALTH"
            else
              echo "Health check FAILED!"
              systemctl status fayaz --no-pager
              exit 1
            fi
